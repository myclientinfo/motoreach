<?php require_once '../include.php';require_once '../classes/class.extend_user.php';require_once '../classes/class.reporting.php';if(!User::hasPermission('Admin')){	header('location: /index.php');	die();}$id = isset($_REQUEST['ID'])? (int)$_REQUEST['ID'] : false;$is_new = $id === 0;$list = $id === false ? true : false;if(!isset($_GET['ob'])) $_GET['ob'] = 'dealership_name';if(!isset($_GET['od'])) $_GET['od'] = 'ASC';$where = 'u.country_id = '.User::getSD('country_id');$where .= ' AND u.user_type_id != 5';if(isset($_GET['approve']) && !isset($_GET['showmoto'])){	$where .= ' AND u.approved = "0" AND u.group_id != 1';	} else if(!isset($_GET['showmoto'])){	$where .= ' AND u.group_id != 1';} else if(isset($_GET['approve'])){	$where .= ' AND u.approved = "0"';} else{	$where .= '';}$content = new Extend_User($id, $list, true, 'auction_users', '', $where);$duplicate = false;if(!empty($_POST)){	$_POST['location_id'] = User::getRegion($_POST['zip']);    $id = $content->save();		if(strstr($id, 'Email address already used')){		$duplicate = $id;		$id = str_replace('ERROR: Email address already used for user id ','', $id);	}    $content = new Extend_User($id, $list, true, 'auction_users', '', $where);		if($is_new) User::addCampaignMonitorSubscriber($content->data);}$main_content = new Template('generic_form');if(!$list){	$form_insert = new Template('admin_user_checkboxes');	$form_insert->set('user_permissions', User::loadUserPermissions($id));	$form_insert->set('is_new', $is_new);		$info_insert = new Template('user_info');		$info_insert->set('vehicles', Reporting::getDealerVehicles($id, false, mktime(0, 0, 0, date('n'), date('j'), date('Y'))));	$info_insert->set('requests', count(Reporting::getRequests($id, false, mktime(0, 0, 0, date('n'), date('j'), date('Y')))));	$info_insert->set('user', $content->data);	$info_insert->set('duplicate', $duplicate);	//echo (int)$duplicate;	$insert_array['before'] = array('user_type_id' => ($id?$info_insert->fetch():'').Site::drawDiv('submit_item_opt_left'), 'email'=>'', 'streetaddress' => Site::drawDiv('submit_item_opt_right'), 'dealership_name' => Site::drawFieldset('admin_dealer_box', 'Dealers Only'));	$insert_array['after'] = array('user_type_id' => BR, 'fullname' => BR, 'password' => BR, 'approved' => $form_insert->fetch().Site::drawDiv(), 'mobile' => '<br />', 'zip' => '<br />', 'rep_number' => Site::drawDiv(), 'account_phone' => Site::drawFieldset());		if($is_new){		$content->data['signup_time'] = date('Y-m-d H:i:s');		$content->data['status'] = 1;		$content->data['approved'] = 1;		$content->data['country_id'] = User::getSD('country_id');		$content->data['public_preferred'] = 0;		if(isset($_GET['public'])) $content->data['user_type_id'] = 5;	}		if(isset($_GET['public'])){		$content->data['user_type_id'] = 5;				$hide_array = array('user_type_id', 'group_id', 'sales_id', 'dealership_name', 'dealer_name', 'dealer_number', 'account_email', 'account_phone','signup_time', 'mobile', 'password', 'public_preferred', 'status', 'approved');		if(User::getSD('country_id')==2) $hide_array[] = 'zip';		foreach($hide_array as $f){			$content->table_field_mapping[$f] = array('type'=>'hidden');		}				//$content->table_field_mapping['user_type_id'] = array('type'=>'hidden');		unset($insert_array['after']['user_type_id'], $insert_array['after']['account_phone'], $insert_array['before']['dealership_name']);	}		$manual_select['user_type_id'] = Site::getLookupTable('user_types', 'id', 'type', 'type', false, false, false);	$manual_select['sales_id'] = Site::getLookupTable('auction_users', 'ID', 'fullname', 'fullname', false, false, false, false, 'user_type_id = 6');	$manual_select['public_preferred'] = array('No', 'Accepted', 'Preferred');	$manual_select['state'] = Site::getLookupTable('states', 'id', 'state', 'id', true, false, false, false, 'country_id = '.$_SESSION['l10n']['country_id']);		$main_content->set('manual_select', $manual_select);} $main_content->set('list', $list);$main_content->set('type', 'User');$main_content->set('content', $list ? $content->data_listing : $content->data);$main_content->set('table_fields', $content->table_fields);if($list){	$link = '?link';	foreach($_GET as $k =>$v){		$link .= '&'.$k.'='.$v;	}	if(!isset($_GET['showmoto'])) $link .= '&showmoto';	$main_content->set('list_header', $content->list_header);	$main_content->set('pre_list', Site::drawDiv('top_right_link').'<a href="'.$link.'">Show MotoReach</a>'.Site::drawDiv());} else {	$main_content->set('insert', $insert_array);	$main_content->set('ediv', array('account_phone'=>'', 'approved'=>''));}$main_content->set('table_field_mapping', $content->table_field_mapping);$template->set('content', $main_content->fetch());echo $template->fetch();?>